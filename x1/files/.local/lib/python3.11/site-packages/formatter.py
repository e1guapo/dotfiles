"""
Minimal compatibility shim for the deprecated Python ``formatter`` module.

Guix's Python build currently omits ``Lib/formatter.py``, but tools such as
Android's ``repo`` launcher (packaged as git-repo) still import the original
``AbstractFormatter``/``DumbWriter`` classes when rendering help text.

We only recreate the tiny subset of behaviour that ``repo`` relies on: the
ability to accumulate flowing text, wrap it to a sensible width, and emit
paragraph separators.  The implementation intentionally stays lightweight so
it can be dropped once Guix restores the upstream module or repo stops
importing it.
"""

from __future__ import annotations

import sys
import textwrap
from typing import List


class DumbWriter:
    """Very small stand-in for the original stdlib DumbWriter."""

    def __init__(self, fileobj=None, width=80):
        self.file = fileobj or sys.stdout
        self.width = width

    def send_flowing_data(self, data: str) -> None:
        self.file.write(data)

    def send_literal_data(self, data: str) -> None:
        self.file.write(data)

    def send_paragraph(self, blankline: bool) -> None:
        """Emit a paragraph break."""
        self.file.write("\n")
        if blankline:
            self.file.write("\n")

    def flush(self) -> None:
        self.file.flush()


class AbstractFormatter:
    """Trimmed-down formatter that only supports flowing paragraphs."""

    def __init__(self, writer: DumbWriter, width: int = 80):
        self.writer = writer
        self.width = width
        self._buffer: List[str] = []

    def add_flowing_data(self, data: str) -> None:
        self._buffer.append(data)

    def add_literal_data(self, data: str) -> None:
        self.writer.send_literal_data(data)

    def end_paragraph(self, blankline: bool) -> None:
        text = "".join(self._buffer).strip()
        if text:
            wrapped = textwrap.wrap(text, width=self.width) or [text]
            for idx, line in enumerate(wrapped):
                self.writer.send_flowing_data(line)
                self.writer.send_flowing_data(
                    "" if idx == len(wrapped) - 1 else "\n"
                )
        self.writer.send_paragraph(blankline)
        self._buffer.clear()
