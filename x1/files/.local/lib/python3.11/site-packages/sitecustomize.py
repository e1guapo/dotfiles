"""
Local sitecustomize hook for Guix Python.

Work around environments (notably SELinux-constrained hosts) where the
default multiprocessing shared memory location (/dev/shm) is not writable
for unprivileged users.  Repo's event_log module uses
``multiprocessing.Value`` at import time, which fails if /dev/shm cannot be
opened.  Detect that scenario early and redirect Python's temporary-file
API to the user's home directory.
"""

from __future__ import annotations

import os
import tempfile


def _ensure_tmpdir_writable() -> None:
    shm = "/dev/shm"
    if os.path.exists(shm) and not os.access(shm, os.W_OK):
        fallback = os.path.expanduser("~/.cache/tmp")
        os.makedirs(fallback, exist_ok=True)
        os.environ.setdefault("TMPDIR", fallback)
        tempfile.tempdir = fallback


_ensure_tmpdir_writable()
